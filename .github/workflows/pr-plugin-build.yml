name: Build PR Plugin

on:
  pull_request:
    paths:
      - 'emhttp/**'
      - '.github/workflows/pr-plugin-build.yml'
      - '.github/scripts/**'

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  build-plugin:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files in emhttp directory using PR SHAs
          git diff --name-only "${{ github.event.pull_request.base.sha }}"..."${{ github.event.pull_request.head.sha }}" | grep '^emhttp/' > changed_files.txt || true
          
          # Output for debugging
          echo "Changed files:"
          cat changed_files.txt
          
          # Check if we have any changes
          if [ ! -s "changed_files.txt" ]; then
            echo "No emhttp files changed"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Generate plugin version
        if: steps.changed-files.outputs.has_changes == 'true'
        id: version
        run: |
          # Generate version based on PR number and short SHA
          VERSION="pr.${{ github.event.pull_request.number }}.$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Create plugin package
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          # Create build directory
          mkdir -p build/usr/local
          
          # Copy changed files preserving directory structure
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # Create directory structure in build
              dir=$(dirname "$file")
              mkdir -p "build/usr/local/$dir"
              cp "$file" "build/usr/local/$dir/"
              echo "Added: $file"
            fi
          done < changed_files.txt
          
          # Create tarball
          cd build
          tar -czf ../webgui-pr-${{ steps.version.outputs.version }}.tar.gz usr/
          cd ..
          
          # Generate file list for plugin
          find build/usr/local/emhttp -type f | sed 's|^build||' > file_list.txt
      
      - name: Configure AWS CLI for R2
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          aws configure set aws_access_key_id ${{ secrets.CLOUDFLARE_PREVIEW_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.CLOUDFLARE_PREVIEW_SECRET_ACCESS_KEY }}
          aws configure set region auto
      
      - name: Upload TXZ to R2
        if: steps.changed-files.outputs.has_changes == 'true'
        id: upload-txz
        run: |
          # Upload to R2 with a path that's easy to prune (pr-plugins/pr-NUMBER/files)
          aws s3 cp webgui-pr-${{ steps.version.outputs.version }}.tar.gz \
            s3://${{ secrets.CLOUDFLARE_PREVIEW_BUCKET_NAME }}/pr-plugins/pr-${{ github.event.pull_request.number }}/ \
            --endpoint-url ${{ secrets.CLOUDFLARE_S3_URL }} \
            --acl public-read
          
          # Construct the public URL
          TXZ_URL="${{ secrets.CLOUDFLARE_PREVIEW_BUCKET_BASE_URL }}/pr-plugins/pr-${{ github.event.pull_request.number }}/webgui-pr-${{ steps.version.outputs.version }}.tar.gz"
          
          echo "txz_url=$TXZ_URL" >> $GITHUB_OUTPUT
          echo "Uploaded TXZ to: $TXZ_URL"
      
      - name: Generate plugin file with R2 URL
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          bash .github/scripts/generate-pr-plugin.sh \
            "${{ steps.version.outputs.version }}" \
            "${{ github.event.pull_request.number }}" \
            "$(git rev-parse --short HEAD)" \
            "webgui-pr-${{ steps.version.outputs.version }}.tar.gz" \
            "${{ steps.upload-txz.outputs.txz_url }}"
      
      - name: Upload PLG to R2
        if: steps.changed-files.outputs.has_changes == 'true'
        id: upload-plg
        run: |
          # Upload PLG to same PR folder
          aws s3 cp webgui-pr-${{ steps.version.outputs.version }}.plg \
            s3://${{ secrets.CLOUDFLARE_PREVIEW_BUCKET_NAME }}/pr-plugins/pr-${{ github.event.pull_request.number }}/ \
            --endpoint-url ${{ secrets.CLOUDFLARE_S3_URL }} \
            --acl public-read
          
          # Construct the public URL
          PLG_URL="${{ secrets.CLOUDFLARE_PREVIEW_BUCKET_BASE_URL }}/pr-plugins/pr-${{ github.event.pull_request.number }}/webgui-pr-${{ steps.version.outputs.version }}.plg"
          
          echo "plg_url=$PLG_URL" >> $GITHUB_OUTPUT
          echo "Uploaded PLG to: $PLG_URL"
      
      - name: Upload artifacts to GitHub (backup)
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: webgui-pr-plugin-${{ github.event.pull_request.number }}
          path: |
            webgui-pr-*.plg
            webgui-pr-*.tar.gz
          retention-days: 30
      
      - name: Format changed files list
        if: steps.changed-files.outputs.has_changes == 'true'
        id: format-files
        run: |
          # Format the file list for the comment
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat changed_files.txt
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## 🔧 PR Test Plugin Available
            
            A test plugin has been generated for this PR that includes the modified files.
            
            **Version:** `${{ steps.version.outputs.version }}`
            **Build:** [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### 📥 Installation Instructions:
            
            **Install via Unraid Web UI:**
            1. Go to **Plugins → Install Plugin**
            2. Copy and paste this URL:
            ```
            ${{ steps.upload-plg.outputs.plg_url }}
            ```
            3. Click **Install**
            
            **Alternative: Direct Download**
            - [📦 Download PLG](${{ steps.upload-plg.outputs.plg_url }})
            - [📦 Download TXZ](${{ steps.upload-txz.outputs.txz_url }})
            
            ### ⚠️ Important Notes:
            
            - **Testing only:** This plugin is for testing PR changes
            - **Backup included:** Original files are automatically backed up
            - **Easy removal:** Files are restored when plugin is removed
            - **Conflicts:** Remove this plugin before installing production updates
            
            ### 📝 Modified Files:
            
            <details>
            <summary>Click to expand file list</summary>
            
            ```
            ${{ steps.format-files.outputs.files }}
            ```
            
            </details>
            
            ### 🔄 To Remove:
            
            Navigate to Plugins → Installed Plugins and remove `webgui-pr-${{ steps.version.outputs.version }}`, or run:
            ```bash
            plugin remove webgui-pr-${{ steps.version.outputs.version }}
            ```
            
            ---
            <sub>🤖 This comment is automatically generated and will be updated with each new push to this PR.</sub>
          edit-mode: replace